from flask import Flask, render_template, send_file
import pandas as pd
import matplotlib.pyplot as plt
import io
import os

app = Flask(__name__)

@app.route('/')
def index():
    # Last inn dataen
    bhgdata = pd.read_excel(
        "ssb-barnehager-2015-2023-alder-1-2-aar.xlsm", 
        sheet_name="KOSandel120000",
        header=3,
        names=["kom", "y15", "y16", "y17", "y18", "y19", "y20", "y21", "y22", "y23"],
        na_values=[".", ".."]
    )

    # Hvilken kommune
    valgt_kommune = "4203 Arendal"
    data_for_kommune = bhgdata[bhgdata["kom"] == valgt_kommune]

    # Beregn prosentandel av barn 1-2 år
    prosent_barn = data_for_kommune[["y15", "y16", "y17", "y18", "y19", "y20", "y21", "y22", "y23"]].values.flatten()

    # År
    år = ["2015", "2016", "2017", "2018", "2019", "2020", "2021", "2022", "2023"]

    # Lag søylediagram
    plt.figure(figsize=(10, 5))
    plt.bar(år, prosent_barn, color="darkcyan")
    plt.title("Prosent av barn i ett- og to-årsalderen i barnehagen for Arendal (2015-2023)")
    plt.xlabel("År")
    plt.ylabel("Prosent")
    plt.xticks(rotation=45)
    plt.grid(axis="y")
    plt.tight_layout()

    # Lagre grafen til en byte-strøm (i minnet)
    img = io.BytesIO()
    plt.savefig(img, format="png")
    img.seek(0)  # Tilbakestill posisjonen i strømmen
    plt.close()  # Lukker figuren for å unngå minnelekkasjer

    # Send grafen til klienten
    return send_file(img, mimetype='image/png')

if __name__ == '__main__':
    app.run(debug=True)